[<div class="col-md-9"> 
 <!-- 教程正文主体部分 --> 
 <h1>8.已上线资产更新</h1> 
 <small>阅读:&nbsp;18576&nbsp;&nbsp;&nbsp;&nbsp; <a href="#comments">评论</a>：7 </small> 
 <hr> 
 <p>前面，我们已经实现了资产进入待审批区、更新待审批区的资产信息以及审批资产上线三个主要功能，还剩下一个最主要的实时更新已上线资产信息的功能。</p> 
 <p>在<code>assets/views.py</code>中的report视图，目前是把已上线资产的数据更新流程‘pass’了，现在将其替换成下面的语句：</p> 
 <div class="codehilite">
  <pre><span></span>update_asset = asset_handler.UpdateAsset(request, asset_obj[0], data)
</pre>
 </div> 
 <p>report视图变成了下面的样子：</p> 
 <div class="codehilite">
  <pre><span></span><span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    通过csrf_exempt装饰器，跳过Django的csrf安全机制，让post的数据能被接收，但这又会带来新的安全问题。</span>
<span class="sd">    可以在客户端，使用自定义的认证token，进行身份验证。这部分工作，请根据实际情况，自己进行。</span>
<span class="sd">    :param request:</span>
<span class="sd">    :return:</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"POST"</span><span class="p">:</span>
        <span class="n">asset_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'asset_data'</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">asset_data</span><span class="p">)</span>
        <span class="c1"># 各种数据检查，请自行添加和完善！</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">"没有数据！"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">"数据必须为字典格式！"</span><span class="p">)</span>
        <span class="c1"># 是否携带了关键的sn号</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'sn'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sn</span><span class="p">:</span>
            <span class="c1"># 进入审批流程</span>
            <span class="c1"># 首先判断是否在上线资产中存在该sn</span>
            <span class="n">asset_obj</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Asset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="n">sn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">asset_obj</span><span class="p">:</span>
                <span class="c1"># 进入已上线资产的数据更新流程</span>
                <span class="n">update_asset</span> <span class="o">=</span> <span class="n">asset_handler</span><span class="o">.</span><span class="n">UpdateAsset</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">asset_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">"资产数据已经更新！"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>   <span class="c1"># 如果已上线资产中没有，那么说明是未批准资产，进入新资产待审批区，更新或者创建资产。</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">asset_handler</span><span class="o">.</span><span class="n">NewAsset</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">add_to_new_assets_zone</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">"没有资产sn序列号，请检查数据！"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">'200 ok'</span><span class="p">)</span>
</pre>
 </div> 
 <p>然后，进入<code>assets/asset_handler.py</code>模块，修改<code>log()</code>方法，并且增加<code>UpdateAsset</code>类：</p> 
 <div class="codehilite">
  <pre><span></span><span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">log_type</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">new_asset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    记录日志</span>
<span class="sd">    """</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EventLog</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">log_type</span> <span class="o">==</span> <span class="s2">"upline"</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">&gt; ：  上线"</span> <span class="o">%</span> <span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span>
        <span class="n">event</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="s2">"资产成功上线！"</span>
        <span class="n">event</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="k">elif</span> <span class="n">log_type</span> <span class="o">==</span> <span class="s2">"approve_failed"</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">&gt; ：  审批失败"</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_asset</span><span class="o">.</span><span class="n">asset_type</span><span class="p">,</span> <span class="n">new_asset</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">new_asset</span> <span class="o">=</span> <span class="n">new_asset</span>
        <span class="n">event</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="s2">"审批失败！</span><span class="se">\n</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">msg</span>
        <span class="n">event</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="k">elif</span> <span class="n">log_type</span> <span class="o">==</span> <span class="s2">"update"</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">&gt; ：  数据更新！"</span> <span class="o">%</span> <span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">asset_type</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span>
        <span class="n">event</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="s2">"更新成功！"</span>
    <span class="k">elif</span> <span class="n">log_type</span> <span class="o">==</span> <span class="s2">"update_failed"</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">&gt; ：  更新失败"</span> <span class="o">%</span> <span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">asset_type</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span>
        <span class="n">event</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="s2">"更新失败！</span><span class="se">\n</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">msg</span>
    <span class="c1"># 更多日志类型.....</span>
    <span class="n">event</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">UpdateAsset</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    自动更新已上线的资产。</span>
<span class="sd">    如果想让记录的日志更详细，可以逐条对比数据项，将更新过的项目记录到log信息中。</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">report_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span> <span class="o">=</span> <span class="n">report_data</span>            <span class="c1"># 此处的数据是由客户端发送过来的整个数据字符串</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset_update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">asset_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 为以后的其它类型资产扩展留下接口</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_</span><span class="si">%s</span><span class="s2">_update"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="p">[</span><span class="s1">'asset_type'</span><span class="p">])</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_server_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_manufacturer</span><span class="p">()</span>   <span class="c1"># 更新厂商</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_server</span><span class="p">()</span>         <span class="c1"># 更新服务器</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_CPU</span><span class="p">()</span>            <span class="c1"># 更新CPU</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_RAM</span><span class="p">()</span>            <span class="c1"># 更新内存</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_disk</span><span class="p">()</span>           <span class="c1"># 更新硬盘</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_nic</span><span class="p">()</span>            <span class="c1"># 更新网卡</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s1">'update_failed'</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 添加日志</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">"update"</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"资产数据被更新!"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_update_manufacturer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新厂商</span>
<span class="sd">        """</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">manufacturer_obj</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Manufacturer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="n">manufacturer_obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">manufacturer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新服务器</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'model'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">os_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'os_type'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">os_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'os_distribution'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">os_release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'os_release'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_CPU</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新CPU信息</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">cpu_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'cpu_model'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">cpu_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'cpu_count'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">cpu_core_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'cpu_core_count'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_RAM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新内存信息。</span>
<span class="sd">        使用集合数据类型中差的概念，处理不同的情况。</span>
<span class="sd">        如果新数据有，但原数据没有，则新增；</span>
<span class="sd">        如果新数据没有，但原数据有，则删除原来多余的部分；</span>
<span class="sd">        如果新的和原数据都有，则更新。</span>
<span class="sd">        在原则上，下面的代码应该写成一个复用的函数，</span>
<span class="sd">        但是由于内存、硬盘、网卡在某些方面的差别，导致很难提取出重用的代码。</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="c1"># 获取已有内存信息，并转成字典格式</span>
        <span class="n">old_rams</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">RAM</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">)</span>
        <span class="n">old_rams_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">old_rams</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ram</span> <span class="ow">in</span> <span class="n">old_rams</span><span class="p">:</span>
                <span class="n">old_rams_dict</span><span class="p">[</span><span class="n">ram</span><span class="o">.</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">ram</span>
        <span class="c1"># 获取新数据中的内存信息，并转成字典格式</span>
        <span class="n">new_rams_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="p">[</span><span class="s1">'ram'</span><span class="p">]</span>
        <span class="n">new_rams_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_rams_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_rams_list</span><span class="p">:</span>
                <span class="n">new_rams_dict</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">'slot'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span>

        <span class="c1"># 利用set类型的差集功能，获得需要删除的内存数据对象</span>
        <span class="n">need_deleted_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_rams_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_rams_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
                <span class="n">old_rams_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># 需要新增或更新的</span>
        <span class="k">if</span> <span class="n">new_rams_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_rams_dict</span><span class="p">:</span>
                <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">'sn'</span><span class="p">:</span> <span class="n">new_rams_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'sn'</span><span class="p">),</span>
                            <span class="s1">'model'</span><span class="p">:</span> <span class="n">new_rams_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'model'</span><span class="p">),</span>
                            <span class="s1">'manufacturer'</span><span class="p">:</span> <span class="n">new_rams_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">),</span>
                            <span class="s1">'capacity'</span><span class="p">:</span> <span class="n">new_rams_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'capacity'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="p">}</span>
                <span class="n">models</span><span class="o">.</span><span class="n">RAM</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新硬盘信息。类似更新内存。</span>
<span class="sd">        """</span>
        <span class="n">old_disks</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Disk</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">)</span>
        <span class="n">old_disks_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">old_disks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">disk</span> <span class="ow">in</span> <span class="n">old_disks</span><span class="p">:</span>
                <span class="n">old_disks_dict</span><span class="p">[</span><span class="n">disk</span><span class="o">.</span><span class="n">sn</span><span class="p">]</span> <span class="o">=</span> <span class="n">disk</span>

        <span class="n">new_disks_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="p">[</span><span class="s1">'physical_disk_driver'</span><span class="p">]</span>
        <span class="n">new_disks_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_disks_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_disks_list</span><span class="p">:</span>
                <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">'sn'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span>

        <span class="c1"># 需要删除的</span>
        <span class="n">need_deleted_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_disks_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_disks_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
                <span class="n">old_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># 需要新增或更新的</span>
        <span class="k">if</span> <span class="n">new_disks_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_disks_dict</span><span class="p">:</span>
                <span class="n">interface_type</span> <span class="o">=</span> <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'interface_type'</span><span class="p">,</span> <span class="s1">'unknown'</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">interface_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'SATA'</span><span class="p">,</span> <span class="s1">'SAS'</span><span class="p">,</span> <span class="s1">'SCSI'</span><span class="p">,</span> <span class="s1">'SSD'</span><span class="p">,</span> <span class="s1">'unknown'</span><span class="p">]:</span>
                    <span class="n">interface_type</span> <span class="o">=</span> <span class="s1">'unknown'</span>
                <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">'slot'</span><span class="p">:</span> <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'slot'</span><span class="p">),</span>
                    <span class="s1">'model'</span><span class="p">:</span> <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'model'</span><span class="p">),</span>
                    <span class="s1">'manufacturer'</span><span class="p">:</span> <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">),</span>
                    <span class="s1">'capacity'</span><span class="p">:</span> <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'capacity'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">'interface_type'</span><span class="p">:</span> <span class="n">interface_type</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">models</span><span class="o">.</span><span class="n">Disk</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_nic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新网卡信息。类似更新内存。</span>
<span class="sd">        """</span>
        <span class="n">old_nics</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NIC</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">)</span>
        <span class="n">old_nics_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">old_nics</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nic</span> <span class="ow">in</span> <span class="n">old_nics</span><span class="p">:</span>
                <span class="n">old_nics_dict</span><span class="p">[</span><span class="n">nic</span><span class="o">.</span><span class="n">model</span><span class="o">+</span><span class="n">nic</span><span class="o">.</span><span class="n">mac</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span>

        <span class="n">new_nics_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="p">[</span><span class="s1">'nic'</span><span class="p">]</span>
        <span class="n">new_nics_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_nics_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_nics_list</span><span class="p">:</span>
                <span class="n">new_nics_dict</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">'model'</span><span class="p">]</span><span class="o">+</span><span class="n">item</span><span class="p">[</span><span class="s1">'mac'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span>

        <span class="c1"># 需要删除的</span>
        <span class="n">need_deleted_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_nics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_nics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
                <span class="n">old_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># 需要新增或更新的</span>
        <span class="k">if</span> <span class="n">new_nics_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_nics_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'net_mask'</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'net_mask'</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">net_mask</span> <span class="o">=</span> <span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'net_mask'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">net_mask</span> <span class="o">=</span> <span class="s2">""</span>
                <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">'name'</span><span class="p">:</span> <span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">),</span>
                    <span class="s1">'ip_address'</span><span class="p">:</span> <span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ip_address'</span><span class="p">),</span>
                    <span class="s1">'net_mask'</span><span class="p">:</span> <span class="n">net_mask</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">models</span><span class="o">.</span><span class="n">NIC</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">'model'</span><span class="p">],</span>
                                                    <span class="n">mac</span><span class="o">=</span><span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">'mac'</span><span class="p">],</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">'更新成功！'</span><span class="p">)</span>
</pre>
 </div> 
 <p>对于log()函数，只是增加了两种数据更新的日志类型，分别记录不同的日志情况，没什么特别的。</p> 
 <p>对于UpdateAsset类，类似前面的ApproveAsset类：</p> 
 <ul> 
  <li>首先初始化动作，自动执行asset_update()方法；</li> 
  <li>依然是通过反射，决定要调用的更新方法；</li> 
  <li>教程实现了主要的服务器类型资产的更新，对于网络设备、安全设备等请自行完善，基本类似；</li> 
  <li><code>_server_update(self)</code>方法中，分别更新厂商、服务器本身、CPU、内存、网卡、硬盘等信息。然后保存数据，这些事务应该是原子性的，所以要抓取异常；</li> 
  <li>不管成功还是失败，都要记录日志。</li> 
 </ul> 
 <p>最主要的，对于<code>_update_CPU(self)</code>等方法，以内存为例，由于内存可能有多条，新的数据中可能出现三种情况，拔除、新增、信息变更，因此要分别对待和处理。</p> 
 <ul> 
  <li>首先，获取已有内存信息，并转成字典格式；</li> 
  <li>其次，获取新数据中的内存信息，并转成字典格式；</li> 
  <li>利用set类型的差集功能，获得需要删除的内存数据对象</li> 
  <li>对要删除的对象，执行delete()方法；</li> 
  <li>对于需要新增或更新的内存对象，首先生成defaults数据字典；</li> 
  <li>然后，使用<code>update_or_create(asset=self.asset, slot=key, defaults=defaults)</code>方法，一次性完成新增或者更新数据的操作，不用写两个方法的代码；</li> 
  <li>硬盘和网卡的操作类同内存的操作。</li> 
 </ul> 
 <p>数据更新完毕后，需要保存asset对象，也就是<code>self.asset.save()</code>，否则前面的工作无法关联保存下来。</p> 
 <p><strong>最终的<code>asset_handler.py</code>如下</strong>：</p> 
 <div class="codehilite">
  <pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">assets</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">NewAsset</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">add_to_new_assets_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'data'</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">'asset_type'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'asset_type'</span><span class="p">),</span>
            <span class="s1">'manufacturer'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">),</span>
            <span class="s1">'model'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'model'</span><span class="p">),</span>
            <span class="s1">'ram_size'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ram_size'</span><span class="p">),</span>
            <span class="s1">'cpu_model'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'cpu_model'</span><span class="p">),</span>
            <span class="s1">'cpu_count'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'cpu_count'</span><span class="p">),</span>
            <span class="s1">'cpu_core_count'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'cpu_core_count'</span><span class="p">),</span>
            <span class="s1">'os_distribution'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'os_distribution'</span><span class="p">),</span>
            <span class="s1">'os_release'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'os_release'</span><span class="p">),</span>
            <span class="s1">'os_type'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'os_type'</span><span class="p">),</span>

        <span class="p">}</span>
        <span class="n">models</span><span class="o">.</span><span class="n">NewAssetApprovalZone</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'sn'</span><span class="p">],</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">'资产已经加入或更新待审批区！'</span>


<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">log_type</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">new_asset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    记录日志</span>
<span class="sd">    """</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EventLog</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">log_type</span> <span class="o">==</span> <span class="s2">"upline"</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">&gt; ：  上线"</span> <span class="o">%</span> <span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span>
        <span class="n">event</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="s2">"资产成功上线！"</span>
        <span class="n">event</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="k">elif</span> <span class="n">log_type</span> <span class="o">==</span> <span class="s2">"approve_failed"</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">&gt; ：  审批失败"</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_asset</span><span class="o">.</span><span class="n">asset_type</span><span class="p">,</span> <span class="n">new_asset</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">new_asset</span> <span class="o">=</span> <span class="n">new_asset</span>
        <span class="n">event</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="s2">"审批失败！</span><span class="se">\n</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">msg</span>
        <span class="n">event</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="k">elif</span> <span class="n">log_type</span> <span class="o">==</span> <span class="s2">"update"</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">&gt; ：  数据更新！"</span> <span class="o">%</span> <span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">asset_type</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span>
        <span class="n">event</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="s2">"更新成功！"</span>
    <span class="k">elif</span> <span class="n">log_type</span> <span class="o">==</span> <span class="s2">"update_failed"</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">&gt; ：  更新失败"</span> <span class="o">%</span> <span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">asset_type</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span>
        <span class="n">event</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="s2">"更新失败！</span><span class="se">\n</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">msg</span>
    <span class="c1"># 更多日志类型.....</span>
    <span class="n">event</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ApproveAsset</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    审批资产并上线。</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">asset_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NewAssetApprovalZone</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">asset_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asset_upline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 为以后的其它类型资产扩展留下接口</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_</span><span class="si">%s</span><span class="s2">_upline"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">asset_type</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_server_upline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 在实际的生产环境中，下面的操作应该是原子性的整体事务，任何一步出现异常，所有操作都要回滚。</span>
        <span class="n">asset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_asset</span><span class="p">()</span>  <span class="c1"># 创建一条资产并返回资产对象。注意要和待审批区的资产区分开。</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_manufacturer</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span> <span class="c1"># 创建厂商</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_server</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>       <span class="c1"># 创建服务器</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_CPU</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>          <span class="c1"># 创建CPU</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_RAM</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>          <span class="c1"># 创建内存</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_disk</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>         <span class="c1"># 创建硬盘</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_nic</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>          <span class="c1"># 创建网卡</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete_original_asset</span><span class="p">()</span>    <span class="c1"># 从待审批资产区删除已审批上线的资产</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">asset</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">log</span><span class="p">(</span><span class="s1">'approve_failed'</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">new_asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 添加日志</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">"upline"</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"新服务器上线!"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_create_asset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        创建资产并上线</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="c1"># 利用request.user自动获取当前管理人员的信息，作为审批人添加到资产数据中。</span>
        <span class="n">asset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Asset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">asset_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">asset_type</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">asset_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">sn</span><span class="p">),</span>
                                            <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">sn</span><span class="p">,</span>
                                            <span class="n">approved_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                            <span class="p">)</span>
        <span class="k">return</span> <span class="n">asset</span>

    <span class="k">def</span> <span class="nf">_create_manufacturer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        创建厂商</span>
<span class="sd">        :param asset:</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="c1"># 判断厂商数据是否存在。如果存在，看看数据库里是否已经有该厂商，再决定是获取还是创建。</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">manufacturer</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">manufacturer_obj</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Manufacturer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
            <span class="n">asset</span><span class="o">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="n">manufacturer_obj</span>
            <span class="n">asset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        创建服务器</span>
<span class="sd">        :param asset:</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Server</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span>
                                     <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                     <span class="n">os_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">os_type</span><span class="p">,</span>
                                     <span class="n">os_distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">os_distribution</span><span class="p">,</span>
                                     <span class="n">os_release</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">os_release</span><span class="p">,</span>
                                     <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_CPU</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        创建CPU.</span>
<span class="sd">        教程这里对发送过来的数据采取了最大限度的容忍，</span>
<span class="sd">        实际情况下你可能还要对数据的完整性、合法性、数据类型进行检测，</span>
<span class="sd">        根据不同的检测情况，是被动接收，还是打回去要求重新收集，请自行决定。</span>
<span class="sd">        这里的业务逻辑非常复杂，不可能面面俱到。</span>
<span class="sd">        :param asset:</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="n">cpu</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CPU</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">)</span>
        <span class="n">cpu</span><span class="o">.</span><span class="n">cpu_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">cpu_model</span>
        <span class="n">cpu</span><span class="o">.</span><span class="n">cpu_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">cpu_count</span>
        <span class="n">cpu</span><span class="o">.</span><span class="n">cpu_core_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">cpu_core_count</span>
        <span class="n">cpu</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_RAM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        创建内存。通常有多条内存</span>
<span class="sd">        :param asset:</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="n">ram_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ram'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ram_list</span><span class="p">:</span>    <span class="c1"># 万一一条内存数据都没有</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">ram_dict</span> <span class="ow">in</span> <span class="n">ram_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ram_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'slot'</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"未知的内存插槽！"</span><span class="p">)</span>  <span class="c1"># 使用虚拟机的时候，可能无法获取内存插槽，需要你修改此处的逻辑。</span>
            <span class="n">ram</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">RAM</span><span class="p">()</span>
            <span class="n">ram</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span>
            <span class="n">ram</span><span class="o">.</span><span class="n">slot</span> <span class="o">=</span> <span class="n">ram_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'slot'</span><span class="p">)</span>
            <span class="n">ram</span><span class="o">.</span><span class="n">sn</span> <span class="o">=</span> <span class="n">ram_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'sn'</span><span class="p">)</span>
            <span class="n">ram</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">ram_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'model'</span><span class="p">)</span>
            <span class="n">ram</span><span class="o">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="n">ram_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">)</span>
            <span class="n">ram</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">ram_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'capacity'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ram</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        存储设备种类多，还有Raid情况，需要根据实际情况具体解决。</span>
<span class="sd">        这里只以简单的SATA硬盘为例子。可能有多块硬盘。</span>
<span class="sd">        :param asset:</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="n">disk_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'physical_disk_driver'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">disk_list</span><span class="p">:</span>  <span class="c1"># 一条硬盘数据都没有</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">disk_dict</span> <span class="ow">in</span> <span class="n">disk_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">disk_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'sn'</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"未知sn的硬盘！"</span><span class="p">)</span>  <span class="c1"># 根据sn确定具体某块硬盘。</span>
            <span class="n">disk</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Disk</span><span class="p">()</span>
            <span class="n">disk</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span>
            <span class="n">disk</span><span class="o">.</span><span class="n">sn</span> <span class="o">=</span> <span class="n">disk_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'sn'</span><span class="p">)</span>
            <span class="n">disk</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">disk_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'model'</span><span class="p">)</span>
            <span class="n">disk</span><span class="o">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="n">disk_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">),</span>
            <span class="n">disk</span><span class="o">.</span><span class="n">slot</span> <span class="o">=</span> <span class="n">disk_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'slot'</span><span class="p">)</span>
            <span class="n">disk</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">disk_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'capacity'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">iface</span> <span class="o">=</span> <span class="n">disk_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'interface_type'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iface</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'SATA'</span><span class="p">,</span> <span class="s1">'SAS'</span><span class="p">,</span> <span class="s1">'SCSI'</span><span class="p">,</span> <span class="s1">'SSD'</span><span class="p">,</span> <span class="s1">'unknown'</span><span class="p">]:</span>
                <span class="n">disk</span><span class="o">.</span><span class="n">interface_type</span> <span class="o">=</span> <span class="n">iface</span>

            <span class="n">disk</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_nic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        创建网卡。可能有多个网卡，甚至虚拟网卡。</span>
<span class="sd">        :param asset:</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="n">nic_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"nic"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nic_list</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">nic_dict</span> <span class="ow">in</span> <span class="n">nic_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nic_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'mac'</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"网卡缺少mac地址！"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nic_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'model'</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"网卡型号未知！"</span><span class="p">)</span>

            <span class="n">nic</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NIC</span><span class="p">()</span>
            <span class="n">nic</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span>
            <span class="n">nic</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">nic_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
            <span class="n">nic</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nic_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'model'</span><span class="p">)</span>
            <span class="n">nic</span><span class="o">.</span><span class="n">mac</span> <span class="o">=</span> <span class="n">nic_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'mac'</span><span class="p">)</span>
            <span class="n">nic</span><span class="o">.</span><span class="n">ip_address</span> <span class="o">=</span> <span class="n">nic_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ip_address'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nic_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'net_mask'</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nic_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'net_mask'</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nic</span><span class="o">.</span><span class="n">net_mask</span> <span class="o">=</span> <span class="n">nic_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'net_mask'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nic</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_delete_original_asset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        这里的逻辑是已经审批上线的资产，就从待审批区删除。</span>
<span class="sd">        也可以设置为修改成已审批状态但不删除，只是在管理界面特别处理，不让再次审批，灰色显示。</span>
<span class="sd">        不过这样可能导致待审批区越来越大。</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_asset</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">UpdateAsset</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    自动更新已上线的资产。</span>
<span class="sd">    如果想让记录的日志更详细，可以逐条对比数据项，将更新过的项目记录到log信息中。</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">report_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span> <span class="o">=</span> <span class="n">report_data</span>            <span class="c1"># 此处的数据是由客户端发送过来的整个数据字符串</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset_update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">asset_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 为以后的其它类型资产扩展留下接口</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_</span><span class="si">%s</span><span class="s2">_update"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="p">[</span><span class="s1">'asset_type'</span><span class="p">])</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_server_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_manufacturer</span><span class="p">()</span>   <span class="c1"># 更新厂商</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_server</span><span class="p">()</span>         <span class="c1"># 更新服务器</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_CPU</span><span class="p">()</span>            <span class="c1"># 更新CPU</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_RAM</span><span class="p">()</span>            <span class="c1"># 更新内存</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_disk</span><span class="p">()</span>           <span class="c1"># 更新硬盘</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_nic</span><span class="p">()</span>            <span class="c1"># 更新网卡</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s1">'update_failed'</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 添加日志</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">"update"</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"资产数据被更新!"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_update_manufacturer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新厂商</span>
<span class="sd">        """</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">manufacturer_obj</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Manufacturer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="n">manufacturer_obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">manufacturer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新服务器</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'model'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">os_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'os_type'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">os_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'os_distribution'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">os_release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'os_release'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_CPU</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新CPU信息</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">cpu_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'cpu_model'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">cpu_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'cpu_count'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">cpu_core_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'cpu_core_count'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">cpu</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_RAM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新内存信息。</span>
<span class="sd">        使用集合数据类型中差的概念，处理不同的情况。</span>
<span class="sd">        如果新数据有，但原数据没有，则新增；</span>
<span class="sd">        如果新数据没有，但原数据有，则删除原来多余的部分；</span>
<span class="sd">        如果新的和原数据都有，则更新。</span>
<span class="sd">        在原则上，下面的代码应该写成一个复用的函数，</span>
<span class="sd">        但是由于内存、硬盘、网卡在某些方面的差别，导致很难提取出重用的代码。</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>
        <span class="c1"># 获取已有内存信息，并转成字典格式</span>
        <span class="n">old_rams</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">RAM</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">)</span>
        <span class="n">old_rams_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">old_rams</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ram</span> <span class="ow">in</span> <span class="n">old_rams</span><span class="p">:</span>
                <span class="n">old_rams_dict</span><span class="p">[</span><span class="n">ram</span><span class="o">.</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">ram</span>
        <span class="c1"># 获取新数据中的内存信息，并转成字典格式</span>
        <span class="n">new_rams_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="p">[</span><span class="s1">'ram'</span><span class="p">]</span>
        <span class="n">new_rams_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_rams_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_rams_list</span><span class="p">:</span>
                <span class="n">new_rams_dict</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">'slot'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span>

        <span class="c1"># 利用set类型的差集功能，获得需要删除的内存数据对象</span>
        <span class="n">need_deleted_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_rams_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_rams_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
                <span class="n">old_rams_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># 需要新增或更新的</span>
        <span class="k">if</span> <span class="n">new_rams_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_rams_dict</span><span class="p">:</span>
                <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">'sn'</span><span class="p">:</span> <span class="n">new_rams_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'sn'</span><span class="p">),</span>
                            <span class="s1">'model'</span><span class="p">:</span> <span class="n">new_rams_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'model'</span><span class="p">),</span>
                            <span class="s1">'manufacturer'</span><span class="p">:</span> <span class="n">new_rams_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">),</span>
                            <span class="s1">'capacity'</span><span class="p">:</span> <span class="n">new_rams_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'capacity'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="p">}</span>
                <span class="n">models</span><span class="o">.</span><span class="n">RAM</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新硬盘信息。类似更新内存。</span>
<span class="sd">        """</span>
        <span class="n">old_disks</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Disk</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">)</span>
        <span class="n">old_disks_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">old_disks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">disk</span> <span class="ow">in</span> <span class="n">old_disks</span><span class="p">:</span>
                <span class="n">old_disks_dict</span><span class="p">[</span><span class="n">disk</span><span class="o">.</span><span class="n">sn</span><span class="p">]</span> <span class="o">=</span> <span class="n">disk</span>

        <span class="n">new_disks_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="p">[</span><span class="s1">'physical_disk_driver'</span><span class="p">]</span>
        <span class="n">new_disks_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_disks_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_disks_list</span><span class="p">:</span>
                <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">'sn'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span>

        <span class="c1"># 需要删除的</span>
        <span class="n">need_deleted_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_disks_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_disks_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
                <span class="n">old_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># 需要新增或更新的</span>
        <span class="k">if</span> <span class="n">new_disks_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_disks_dict</span><span class="p">:</span>
                <span class="n">interface_type</span> <span class="o">=</span> <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'interface_type'</span><span class="p">,</span> <span class="s1">'unknown'</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">interface_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'SATA'</span><span class="p">,</span> <span class="s1">'SAS'</span><span class="p">,</span> <span class="s1">'SCSI'</span><span class="p">,</span> <span class="s1">'SSD'</span><span class="p">,</span> <span class="s1">'unknown'</span><span class="p">]:</span>
                    <span class="n">interface_type</span> <span class="o">=</span> <span class="s1">'unknown'</span>
                <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">'slot'</span><span class="p">:</span> <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'slot'</span><span class="p">),</span>
                    <span class="s1">'model'</span><span class="p">:</span> <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'model'</span><span class="p">),</span>
                    <span class="s1">'manufacturer'</span><span class="p">:</span> <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'manufacturer'</span><span class="p">),</span>
                    <span class="s1">'capacity'</span><span class="p">:</span> <span class="n">new_disks_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'capacity'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">'interface_type'</span><span class="p">:</span> <span class="n">interface_type</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">models</span><span class="o">.</span><span class="n">Disk</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_nic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        更新网卡信息。类似更新内存。</span>
<span class="sd">        """</span>
        <span class="n">old_nics</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NIC</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">)</span>
        <span class="n">old_nics_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">old_nics</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nic</span> <span class="ow">in</span> <span class="n">old_nics</span><span class="p">:</span>
                <span class="n">old_nics_dict</span><span class="p">[</span><span class="n">nic</span><span class="o">.</span><span class="n">model</span><span class="o">+</span><span class="n">nic</span><span class="o">.</span><span class="n">mac</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span>

        <span class="n">new_nics_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_data</span><span class="p">[</span><span class="s1">'nic'</span><span class="p">]</span>
        <span class="n">new_nics_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_nics_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_nics_list</span><span class="p">:</span>
                <span class="n">new_nics_dict</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">'model'</span><span class="p">]</span><span class="o">+</span><span class="n">item</span><span class="p">[</span><span class="s1">'mac'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span>

        <span class="c1"># 需要删除的</span>
        <span class="n">need_deleted_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_nics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_nics_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">need_deleted_keys</span><span class="p">:</span>
                <span class="n">old_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="c1"># 需要新增或更新的</span>
        <span class="k">if</span> <span class="n">new_nics_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_nics_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'net_mask'</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'net_mask'</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">net_mask</span> <span class="o">=</span> <span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'net_mask'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">net_mask</span> <span class="o">=</span> <span class="s2">""</span>
                <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">'name'</span><span class="p">:</span> <span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">),</span>
                    <span class="s1">'ip_address'</span><span class="p">:</span> <span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ip_address'</span><span class="p">),</span>
                    <span class="s1">'net_mask'</span><span class="p">:</span> <span class="n">net_mask</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">models</span><span class="o">.</span><span class="n">NIC</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span><span class="n">asset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">'model'</span><span class="p">],</span>
                                                    <span class="n">mac</span><span class="o">=</span><span class="n">new_nics_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">'mac'</span><span class="p">],</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">'更新成功！'</span><span class="p">)</span>
</pre>
 </div> 
 <p>现在，可以测试一下资产数据的更新了。重启CMDB，然后转到Client/report_assetss.py脚本，修改其中的一些数据，删除或增加一些内存、硬盘、网卡的条目。<strong>注意数据格式必须正确，sn必须不能变。</strong></p> 
 <p>再次运行脚本，报告数据。进入admin中查看相关内容，可以看到数据已经得到更新了。</p> 
 <p>至此，CMDB自动资产管理系统的后台部分已经完成了。</p> 
 <hr> 
 <!-- 教程导航条 --> 
 <div> 
  <a href="/course/django/123"> <i class="fa fa-arrow-left"></i>&nbsp;7.审批新资产</a> 
  <a class="float-right" href="/course/django/125"> 9.前端框架AdminLTE&nbsp;<i class="fa fa-arrow-right"></i></a> 
 </div> 
 <!-- 教程导航条结束 --> 
 <hr> 
 <!-- 评论区--> 
 <!-- 显示评论条数--> 
 <h4>评论总数： 7</h4> 
 <hr> 
 <!-- 评论表单区--> 
 <div> 
  <a class="text-danger" href="https://api.weibo.com/oauth2/authorize?client_id=3191049160&amp;response_type=code&amp;redirect_uri=http://www.liujiangblog.com/login?next=/course/django/124">点击登录后方可评论</a> 
 </div> 
 <!-- 评论表单区结束--> 
 <hr> 
 <!-- 评论显示区--> 
 <div id="comments"> 
  <div class="comment " style="margin-left: 0em"> 
   <div class="row"> 
    <div> 
     <img src="http://tvax3.sinaimg.cn/default/images/default_avatar_male_50.gif" alt="user_image"> 
    </div> 
    <div class="comment-content  col-md-10"> 
     <p>数据更新完毕后，需要保存asset对象，也就是self.asset.save()，否则前面的工作无法关联保存下来。&lt;br/&gt; 博主这个是为什么？更新的都是关联数据，而且各自的方法都调用过 save() 了，这个这里主键表的数据为什么还要 save()？</p> 
     <br> 
     <div class="comment_footer small mute"> 
      <span>By&nbsp;&nbsp; 忧郁发条人 </span>&nbsp;&nbsp;&nbsp;On&nbsp;&nbsp; 
      <em>2019年3月5日 17:44</em>&nbsp;&nbsp; 
      <a class="text-info" href="/reply/1116">回复</a> 
     </div> 
     <br> 
    </div> 
   </div> 
  </div> 
  <div class="comment " style="margin-left: 0em"> 
   <div class="row"> 
    <div> 
     <img src="http://tvax3.sinaimg.cn/default/images/default_avatar_male_50.gif" alt="user_image"> 
    </div> 
    <div class="comment-content  col-md-10"> 
     <p>新手运维这里要注意，实际环境中，更换内存或者硬盘，那原来的旧内存旧硬盘不应该 delete() 删除，而是应该设置为下架。博主这里是为了方便大家理解才直接 delete掉，避免大家绕晕。</p> 
     <br> 
     <div class="comment_footer small mute"> 
      <span>By&nbsp;&nbsp; 忧郁发条人 </span>&nbsp;&nbsp;&nbsp;On&nbsp;&nbsp; 
      <em>2019年3月5日 17:37</em>&nbsp;&nbsp; 
      <a class="text-info" href="/reply/1115">回复</a> 
     </div> 
     <br> 
    </div> 
   </div> 
  </div> 
  <div class="comment " style="margin-left: 0em"> 
   <div class="row"> 
    <div> 
     <img src="http://tvax3.sinaimg.cn/default/images/default_avatar_male_50.gif" alt="user_image"> 
    </div> 
    <div class="comment-content  col-md-10"> 
     <p>不应该是new_rams_dict['item'] = item这样吗？</p> 
     <br> 
     <div class="comment_footer small mute"> 
      <span>By&nbsp;&nbsp; 真司仪 </span>&nbsp;&nbsp;&nbsp;On&nbsp;&nbsp; 
      <em>2018年12月29日 16:49</em>&nbsp;&nbsp; 
      <a class="text-info" href="/reply/987">回复</a> 
     </div> 
     <br> 
    </div> 
   </div> 
  </div> 
  <div class="comment " style="margin-left: 4em"> 
   <div class="row"> 
    <div> 
     <img src="http://tvax1.sinaimg.cn/crop.79.178.566.566.50/005PMdg8ly8fjzip8l3ibj30k00scgr3.jpg" alt="user_image"> 
    </div> 
    <div class="comment-content  col-md-10"> 
     <p>这个确实比较绕</p> 
     <br> 
     <div class="comment_footer small mute"> 
      <span> <span class="badge badge-info">&nbsp;博主</span> &nbsp;&nbsp;回复&nbsp;&nbsp; 真司仪 </span> 
      <em>2019年1月1日 11:35</em>&nbsp;&nbsp; 
      <a class="text-info" href="/reply/999">回复</a> 
     </div> 
     <br> 
    </div> 
   </div> 
  </div> 
  <div class="comment " style="margin-left: 4em"> 
   <div class="row"> 
    <div> 
     <img src="http://tvax3.sinaimg.cn/default/images/default_avatar_male_50.gif" alt="user_image"> 
    </div> 
    <div class="comment-content  col-md-10"> 
     <p>key 值应该是一个变量，不然就只会不断覆盖。</p> 
     <br> 
     <div class="comment_footer small mute"> 
      <span> 忧郁发条人 &nbsp;&nbsp;回复&nbsp;&nbsp; 真司仪 </span> 
      <em>2019年3月5日 17:35</em>&nbsp;&nbsp; 
      <a class="text-info" href="/reply/1114">回复</a> 
     </div> 
     <br> 
    </div> 
   </div> 
  </div> 
  <div class="comment " style="margin-left: 0em"> 
   <div class="row"> 
    <div> 
     <img src="http://tvax3.sinaimg.cn/crop.0.0.480.480.50/005NtmT0ly8fwh5kv0nqlj30dc0dcmxp.jpg" alt="user_image"> 
    </div> 
    <div class="comment-content  col-md-10"> 
     <p>审批失败! 'NewAssetApprovalZone' object has no attribute 'os_type'</p> 
     <br> 
     <div class="comment_footer small mute"> 
      <span>By&nbsp;&nbsp; IIRROONN_Stark </span>&nbsp;&nbsp;&nbsp;On&nbsp;&nbsp; 
      <em>2018年10月30日 16:27</em>&nbsp;&nbsp; 
      <a class="text-info" href="/reply/810">回复</a> 
     </div> 
     <br> 
    </div> 
   </div> 
  </div> 
  <div class="comment " style="margin-left: 4em"> 
   <div class="row"> 
    <div> 
     <img src="http://tvax2.sinaimg.cn/default/images/default_avatar_male_50.gif" alt="user_image"> 
    </div> 
    <div class="comment-content  col-md-10"> 
     <p>在models.py文件中的NewAssetApprovalZone类中加上os_type字段即可</p> 
     <br> 
     <div class="comment_footer small mute"> 
      <span> 情调102 &nbsp;&nbsp;回复&nbsp;&nbsp; IIRROONN_Stark </span> 
      <em>2018年12月11日 13:14</em>&nbsp;&nbsp; 
      <a class="text-info" href="/reply/935">回复</a> 
     </div> 
     <br> 
    </div> 
   </div> 
  </div> 
  <!-- 评论显示区结束--> 
  <!-- 评论区结束--> 
 </div> 
 <!-- 右侧正文栏结束 --> 
</div>]